<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Teams Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        agent: {
                            blue: '#3b82f6',
                            green: '#22c55e',
                            purple: '#a855f7',
                            orange: '#f97316',
                            pink: '#ec4899',
                            cyan: '#06b6d4',
                            red: '#ef4444',
                            yellow: '#eab308',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <h1 class="text-lg font-semibold text-gray-900">Agent Teams Monitor</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="relative" id="settings-wrapper">
                    <button id="settings-btn"
                        class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded"
                        title="Notification settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                    </button>
                    <div id="settings-dropdown" class="hidden absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg p-3 w-64 z-50">
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Notifications</div>
                        <label class="flex items-center justify-between py-1.5 cursor-pointer">
                            <span class="text-sm text-gray-700">Browser notifications</span>
                            <input type="checkbox" id="toggle-notifications" class="rounded">
                        </label>
                        <label class="flex items-center justify-between py-1.5 cursor-pointer">
                            <span class="text-sm text-gray-700">Sound alerts</span>
                            <input type="checkbox" id="toggle-sound" class="rounded">
                        </label>
                        <div class="border-t border-gray-200 mt-2 pt-2">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Auto-Approval</div>
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <span class="text-sm text-gray-700">Enable auto-approval</span>
                                <input type="checkbox" id="toggle-auto-approve" class="rounded">
                            </label>
                            <div id="auto-approve-tools" class="mt-1 ml-1">
                                <div class="text-xs text-gray-400 mb-1">Auto-approved tools:</div>
                                <div class="grid grid-cols-2 gap-x-2 gap-y-0.5">
                                    <label class="flex items-center gap-1.5 py-0.5 cursor-pointer">
                                        <input type="checkbox" value="Read" class="auto-approve-tool rounded text-xs">
                                        <span class="text-xs text-gray-600">Read</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 py-0.5 cursor-pointer">
                                        <input type="checkbox" value="Glob" class="auto-approve-tool rounded text-xs">
                                        <span class="text-xs text-gray-600">Glob</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 py-0.5 cursor-pointer">
                                        <input type="checkbox" value="Grep" class="auto-approve-tool rounded text-xs">
                                        <span class="text-xs text-gray-600">Grep</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 py-0.5 cursor-pointer">
                                        <input type="checkbox" value="WebSearch" class="auto-approve-tool rounded text-xs">
                                        <span class="text-xs text-gray-600">WebSearch</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 py-0.5 cursor-pointer">
                                        <input type="checkbox" value="WebFetch" class="auto-approve-tool rounded text-xs">
                                        <span class="text-xs text-gray-600">WebFetch</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 py-0.5 cursor-pointer">
                                        <input type="checkbox" value="Bash" class="auto-approve-tool rounded text-xs">
                                        <span class="text-xs text-gray-600">Bash</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 py-0.5 cursor-pointer">
                                        <input type="checkbox" value="Write" class="auto-approve-tool rounded text-xs">
                                        <span class="text-xs text-gray-600">Write</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 py-0.5 cursor-pointer">
                                        <input type="checkbox" value="Edit" class="auto-approve-tool rounded text-xs">
                                        <span class="text-xs text-gray-600">Edit</span>
                                    </label>
                                    <label class="flex items-center gap-1.5 py-0.5 cursor-pointer">
                                        <input type="checkbox" value="NotebookEdit" class="auto-approve-tool rounded text-xs">
                                        <span class="text-xs text-gray-600">NotebookEdit</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="live-indicator" class="flex items-center gap-1.5 text-sm">
                    <span class="relative flex h-2.5 w-2.5">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                    </span>
                    <span class="text-green-600 font-medium">Live</span>
                </div>
                <button id="pause-btn"
                    class="text-sm px-3 py-1 rounded border border-gray-300 hover:bg-gray-50 text-gray-600 transition-colors">
                    Pause
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- Overview View -->
        <div id="overview-view">
            <div id="teams-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Team cards rendered by JS -->
            </div>
            <div id="overview-empty" class="hidden text-center py-20">
                <div class="text-gray-400 text-5xl mb-4">&#x1f916;</div>
                <h2 class="text-xl font-medium text-gray-600 mb-2">No active teams</h2>
                <p class="text-gray-400">Start a team with Claude Code to see it here</p>
            </div>
            <div id="overview-loading" class="text-center py-20">
                <div class="inline-block w-8 h-8 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
                <p class="text-gray-400 mt-3">Loading teams...</p>
            </div>
        </div>

        <!-- Team Detail View -->
        <div id="detail-view" class="hidden">

            <!-- Back + Header -->
            <div class="flex items-center gap-3 mb-4">
                <button id="back-btn"
                    class="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Back
                </button>
                <h2 id="team-name-header" class="text-xl font-semibold text-gray-900"></h2>
                <div id="health-badge-container" class="hidden ml-2 flex items-center gap-2"></div>
                <span id="team-description-header" class="text-sm text-gray-400 ml-2"></span>
            </div>

            <!-- Action Bar (compact, single line) -->
            <div id="action-bar" class="hidden mb-4 sticky top-14 z-40 bg-gray-50 pt-2 pb-2">
                <div class="bg-white border border-gray-200 rounded-lg px-4 py-2 flex items-center gap-3 flex-wrap shadow-sm">
                    <div id="action-bar-content" class="flex items-center gap-3 flex-wrap flex-1">
                        <!-- Rendered by JS -->
                    </div>
                </div>
                <div id="action-bar-details" class="hidden mt-1 bg-white border border-gray-200 rounded-lg px-4 py-3 space-y-2 shadow-sm">
                    <!-- Expanded detail items rendered by JS -->
                </div>
            </div>

            <!-- Health Breakdown (inline) -->
            <div id="health-breakdown-inline" class="hidden mb-4 bg-white rounded-lg border border-gray-200 px-4 py-3">
                <div class="flex items-center gap-3 mb-3">
                    <span id="health-score-display" class="inline-flex items-center justify-center w-9 h-9 rounded-full text-sm font-bold"></span>
                    <span id="health-label-display" class="text-sm font-semibold text-gray-800"></span>
                </div>
                <div id="health-dimensions" class="space-y-2">
                    <!-- Dimension rows rendered by JS -->
                </div>
            </div>

            <!-- Two-Column Layout -->
            <div class="flex flex-col lg:flex-row gap-6">

                <!-- LEFT COLUMN: Agent Sidebar + Tasks (~30%) -->
                <div class="w-full lg:w-[30%] flex flex-col gap-4">

                    <!-- Agent Sidebar -->
                    <div id="agent-sidebar" class="bg-white rounded-lg border border-gray-200 p-4">
                        <div id="agent-summary" class="mb-3">
                            <!-- Summary line + progress bar rendered by JS -->
                        </div>
                        <div id="agent-list" class="space-y-2">
                            <!-- Vertical agent cards rendered by JS -->
                        </div>
                    </div>

                    <!-- Compact Task List -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium text-gray-700">Tasks</h3>
                            <div class="flex items-center gap-2">
                                <input id="tasks-search-input" type="text" placeholder="Search..."
                                    class="w-20 text-xs border border-gray-300 rounded px-2 py-1 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                <select id="tasks-owner-filter"
                                    class="text-xs border border-gray-300 rounded px-2 py-1 bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                    <option value="all">All owners</option>
                                </select>
                                <select id="tasks-status-filter"
                                    class="text-xs border border-gray-300 rounded px-2 py-1 bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                    <option value="all">All</option>
                                    <option value="pending">Pending</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        <div id="task-list" class="space-y-1">
                            <!-- Compact task rows rendered by JS -->
                        </div>
                        <div id="tasks-empty" class="hidden text-center py-8 text-gray-400 text-sm">
                            No tasks yet
                        </div>
                    </div>

                    <!-- Task Timeline -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Task Timeline</h3>
                        <div id="task-timeline-feed" class="space-y-2">
                            <!-- Task timeline items rendered by JS -->
                        </div>
                        <div id="task-timeline-empty" class="hidden text-center py-8 text-gray-400 text-sm">
                            No state transitions yet
                        </div>
                    </div>

                </div>

                <!-- RIGHT COLUMN: Message Feed & Timeline (~70%) -->
                <div class="w-full lg:w-[70%] flex flex-col gap-4">

                    <!-- Agent Timeline (collapsible) -->
                    <div id="timeline-section" class="mb-2">
                        <button id="timeline-toggle"
                            class="w-full flex items-center justify-between bg-white border border-gray-200 rounded-lg px-4 py-2.5 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center gap-2">
                                <h3 class="text-sm font-medium text-gray-700">Agent Timeline</h3>
                                <span id="timeline-agent-count" class="text-xs text-gray-400"></span>
                            </div>
                            <svg id="timeline-chevron" class="w-4 h-4 text-gray-400 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="timeline-content" class="mt-2">
                            <div id="swim-lanes-container" class="bg-white rounded-lg border border-gray-200">
                                <!-- Swim lanes rendered by JS -->
                            </div>
                            <div id="timeline-empty" class="hidden text-center py-12 text-gray-400 bg-white rounded-lg border border-gray-200">
                                <p>No timeline events yet</p>
                                <p class="text-sm mt-1">Events appear as agent tasks change status</p>
                            </div>
                        </div>
                    </div>

                    <!-- Send Form (at top of conversation) -->
                    <div id="send-form" class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
                        <div class="flex gap-2">
                            <select id="msg-agent-select"
                                class="text-sm border border-gray-300 rounded-lg px-2 py-1.5 bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none w-32">
                                <option value="">Agent...</option>
                            </select>
                            <input id="msg-text-input" type="text" placeholder="Type a message..."
                                class="flex-1 text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <button id="msg-send-btn"
                                class="text-sm px-4 py-1.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                                disabled>
                                Send
                            </button>
                        </div>
                    </div>

                    <!-- Message Filters (single row below send form) -->
                    <div class="bg-white rounded-lg border border-gray-200 p-3 flex flex-col md:flex-row gap-3 items-center shadow-sm">
                        <input id="messages-search-input" type="text" placeholder="Search messages..."
                            class="flex-1 text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 focus:outline-none min-w-0">
                        <select id="messages-agent-filter"
                            class="text-sm border border-gray-300 rounded-lg px-2 py-1.5 bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none max-w-[120px]">
                            <option value="all">All agents</option>
                        </select>
                        <select id="messages-type-filter"
                            class="text-sm border border-gray-300 rounded-lg px-2 py-1.5 bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none max-w-[140px]">
                            <option value="all">All types</option>
                            <option value="plain">Plain</option>
                            <option value="permission_request">Perm Request</option>
                            <option value="permission_response">Perm Response</option>
                            <option value="shutdown_request">Shutdown</option>
                        </select>
                        <div class="relative group flex-shrink-0">
                            <button type="button" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg border border-gray-300 transition-colors flex items-center justify-center" title="View options">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                                </svg>
                            </button>
                            <div class="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg p-2 w-48 z-50 hidden group-hover:block hover:block">
                                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2 px-1">View options</div>
                                <label class="flex items-center justify-between py-1.5 px-1 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="text-sm text-gray-700">Show unresolved</span>
                                    <input type="checkbox" id="toggle-unresolved" class="rounded">
                                </label>
                                <label class="flex items-center justify-between py-1.5 px-1 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="text-sm text-gray-700">Group by pair</span>
                                    <input type="checkbox" id="toggle-group-pair" class="rounded">
                                </label>
                                <label class="flex items-center justify-between py-1.5 px-1 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="text-sm text-gray-700">System events</span>
                                    <input type="checkbox" id="toggle-system-msgs" class="rounded">
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- New messages indicator (when user has scrolled down; click scrolls to top) -->
                    <div id="new-messages-indicator" class="hidden text-center py-1">
                        <button type="button" onclick="scrollToLatestMessage()"
                            class="text-xs px-3 py-1.5 bg-blue-500 text-white rounded-full shadow hover:bg-blue-600 transition-colors">
                            <span id="new-messages-count"></span> new messages &uarr;
                        </button>
                    </div>

                    <!-- Message Feed (newest at top) -->
                    <div id="message-feed" class="space-y-2 flex-1 min-h-0 overflow-y-auto">
                        <!-- Messages rendered by JS; newest first -->
                    </div>
                    <div id="messages-empty" class="hidden text-center py-12 text-gray-400 bg-white rounded-lg border border-gray-200">
                        No messages yet
                    </div>
                </div>

            </div>

        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script src="/static/js/helpers.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/render-overview.js"></script>
    <script src="/static/js/render-detail.js"></script>
    <script src="/static/js/render-timeline.js"></script>
    <script src="/static/js/handlers.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
